# -*- mode: shell-script -*-
#

# ######################################################################
# # VirtualEnv
# export WORKON_HOME=$HOME/.virtualenvs
# export PROJECT_HOME=$HOME/Dropbox/Development/python
# alias mkve='mkvirtualenv'
# alias setvep='setvirtualenvproject'
# . /usr/local/bin/virtualenvwrapper.sh

# python_valid_identifier() {
#   string = string.strip()
#   string = string.replace("-", "_")
#   string = string.replace(" ", "_")
#   string = re.sub('[^_a-zA-Z0-9]', '_', string)
#   string = string.lower()
# }

create_tox_file() {
  toxini='tox.ini'
  rm -rf tox.ini
  cat << \EOF > ${toxini}
#!/usr/bin/env python
# -*- coding: utf-8 -*-
# tox (https://tox.readthedocs.io/) is a tool for running tests in multiple
# virtualenvs. This configuration file will run the test suite on all supported
# python versions referenced in the 'envlist' (py{...}) below.

[tox]
skipsdist = True
envlist = py{37},flake8
skip_missing_interpreters = True

[testenv]
# uncomment to omit testing package builds & installs for faster runs
skipsdist=True
whitelist_externals = python
extras = testing
# deps =
    # dependencies go here
commands =
    python setup.py develop
    pytest --basetemp={envtmpdir} {posargs}

[testenv:flake8]
skip_install = true
changedir = {toxinidir}
deps = flake8
commands = flake8 setup.py src tests

[flake8]
ignore =
    # E712    # poor comparison to False
    # E501    # line too long
    # F401    # imported but unused
    # E722    # do not use bare except
    # E402    # module level import not at top of file
    # E241    # multiple spaces after ','
    # E226    # missing white space around arithmetic operator
    # E222    # multiple spaces after operator
    # W503    # line break before binary operator
    # W504    # line break after binary operator
EOF
}

customise_scaffold() {
  readmerst='README.rst'
  readme='README.md'

  perl -pi -e "s/=//g" $readmerst
  perl -pi -e "s/^($1)/# \1/g" $readmerst
  tail -n +2 $readmerst > $readme

  perl -pi -e "s/(Description)/## \1/g" $readme
  perl -pi -e "s/(Note)/## \1/g" $readme
  cat << \EOF >> $readme

## Dev

Add requirements using `pipenv`, e.g.:

```sh
$ pipenv install click
# or (for dev requirements)
$ pipenv install --dev pytest
```

To run tests AUTOMATICALLY:

```sh
$ autotox                           # Run from regular shell (NOT pipenv shell)
# or
$ pyautotest                        # Run from pipenv shell
```

To run tests MANUALLY:

```sh
$ tox                               # Run from regular shell (NOT pipenv shell)
# or
$ python setup.py test              # Run from pipenv shell
```

To view test coverage:

```sh
$ open htmlcov/index.html
```
EOF

  setupcfg='setup.cfg'
  perl -pi -e "s/(--cov\s*).*(--cov-report\s*).*/\1src \2html --last-failed/g" $setupcfg
  perl -pi -e "s/(description-file =) $readmerst/\1 $readme/g" $setupcfg
  perl -pi -e "s/\[(pytest)\]/\[tool:\1\]/g" $setupcfg

  create_tox_file

  rm -f $readmerst AUTHORS.rst CHANGELOG.rst LICENSE.txt

  rm -rf docs

  setup_test_dir

  scaffold_pipenv
}

customise_sam() {
  template='template.yaml'

  perl -pi -e "s/(CodeUri:\s*).*/\1lambda_package\//g" $template
  perl -pi -e "s/(Handler:\s*)(.*)/\1hello_world.\2/g" $template
  perl -pi -e "s/'|\"//g" $template
}

setup_test_dir() {
  mkdir -p tests/unit tests/fixtures
  mv -f tests/test_skeleton.py tests/unit
  touch tests/unit/__init__.py
}

scaffold_pipenv() {
  if [ -f requirements.txt ]; then
    pipenv install -r requirements.txt
  fi

  if [ -f test-requirements.txt ]; then
    pipenv install --dev -r test-requirements.txt
  fi

  rm -rf requirements.txt test-requirements.txt
}

reset_git() {
  rm -rf .git
  git init
  touch .gitignore
  cat .gitignore | grep -q -s "DS_Store"
  if [ $? -eq 1 ] ; then
    echo "\n" >> .gitignore
    curl -s 'https://raw.githubusercontent.com/github/gitignore/master/Global/macOS.gitignore' >> .gitignore
  fi
  # cat .gitignore | grep -q -s "Pipfile.lock"
  # if [ $? -eq 1 ] ; then
  #   echo "\n# pipenv" >> .gitignore
  #   echo "Pipfile.lock" >> .gitignore
  # fi
  git add .
  git commit -a -m "Initial project setup"
}

make_project_dir() {
  echo "Creating new python pipenv and project directory '$1' at $PWD/$1"
  mkdir -p $1 && cd $1
  pipenv --python $(which python3)
}

add_sam_makefile() {
  makefile='Makefile'
  rm -rf ${makefile}
  cat << \EOF > ${makefile}
VERSION=$$(date +"%Y%m%d_%H%M%S")
COMPONENT=COMPONENT_NAME_HERE
TEMPLATE_FILE=template.yaml
PACKAGE_FILE=deploy.yaml
CF_BUCKET=users-infrastructure-starlingbank-com-k8d4j5r5ack9

pip-setup:
	pipenv install --dev

pip-update: pip-setup

test:
	python setup.py test

clean:
  rm -rf .tox .eggs .pytest_cache
	rm -rf lambda_package.zip lambda_package deploy.yaml
	find . -name "*.pyc" -depth -exec rm -rf {} \;
	find . -name "__pycache__" -depth -exec rm -rf {} \;
	find . -name "*.egg-info" -depth -exec rm -rf {} \;

build:
	pipenv lock -r | sed 's/-e //g' | pipenv run pip install -r /dev/stdin --target lambda_package
	rsync -avm --include='*.py' -f 'hide,! */' src/* lambda_package

package:
	cd lambda_package && zip -r9 ../lambda_package.zip *
	rm -rf lambda_package

make: sam package

sam: clean build

samvalidate:
	pipenv run sam validate

sampackage: samvalidate sam
	@echo "Packaging version ${USER}/${VERSION}"
	@pipenv run sam package \
      --template-file ${TEMPLATE_FILE} \
      --s3-bucket ${CF_BUCKET} \
      --s3-prefix ${COMPONENT}/${USER}/${VERSION} \
      --output-template-file ${PACKAGE_FILE}
	rm -rf lambda_package

samdeploy:
	@pipenv run sam deploy \
			--capabilities CAPABILITY_NAMED_IAM CAPABILITY_IAM \
			--template-file ${PACKAGE_FILE} \
			--stack-name ${COMPONENT}

samclean: clean
	@pipenv run aws s3 rm \
	    s3://${CF_BUCKET}/${COMPONENT}/ \
	      --recursive \
	      --exclude "*" \
	      --include "*${USER}*"
EOF
perl -pi -e "s/COMPONENT_NAME_HERE/$1/g" ${makefile}
}

add_scaffold() {
  : ${2:=--force}
  pipenv install --dev pyscaffold pytest pytest-cov pytest-mock
  pipenv run putup --tox $1 $2
  cp -Rf $1/.* .
  cp -Rf $1/* .
  rm -rf $1
  customise_scaffold $1
  pipenv run python setup.py develop
}

add_sam() {
  pipenv install --dev aws-sam-cli boto3 moto
  pipenv run sam init --runtime python --name $1
  mkdir -p tests/unit src
  mv -f $1/tests/unit/*.py tests/unit/
  mv -f $1/hello_world src
  mv -f $1/template.yaml .
  mv -f $1/README.md README-SAM.md
  touch .gitignore
  touch $1/.gitignore
  cat $1/.gitignore >> .gitignore
  customise_sam $1
  rm -rf $1
  pipenv run python setup.py develop
  add_sam_makefile $1
}

### python 2 version
py2new() {
  : ${2:=--force}
  echo "Creating new python pipenv and project directory '$1' at $PWD/$1"
  mkdir $1 && cd $1
  pipenv --python $(which python2)

  pipenv install --dev pyscaffold==2.5 tox
  pipenv run putup --tox $1 $2
  cp -rf $1/.* .
  cp -rf $1/* .
  rm -rf $1
  customise_scaffold $1

  reset_git

  pipenv run atom .

  pipenv shell
}
# call above with
# $ pynew foo [--update|--force]

### python 3 version
pynew() {
  make_project_dir $1

  add_scaffold $1 $2

  reset_git

  pipenv run atom .

  pipenv shell
}
# call above with
# $ pynewenv foo [--update]
# run py[auto]test from pipenv shell
# run [auto]tox from regular shell
######################################################################

### python 3 version
pynewsam() {
  make_project_dir $1

  add_scaffold $1 $2

  add_sam $1

  reset_git

  pipenv run atom .

  pipenv shell
}
# call above with
# $ pynewenv foo [--update]
######################################################################


pyautotest () {
  echo "watching for changes..."
  watchmedo shell-command                 \
    --wait                                \
    --patterns="*.py;*.txt;*.ini;*.cfg"   \
    --recursive                           \
    --ignore-pattern="*egg*;*.pyc;*.tox*"  \
    --command='clear; echo "${watch_event_type} ${watch_src_path}"; echo "launching pytest..."; python setup.py test' \
    .
}

autotox () {
  echo "watching for changes..."
  watchmedo shell-command                 \
    --wait                                \
    --patterns="*.py;*.txt;*.ini;*.cfg"   \
    --recursive                           \
    --ignore-pattern="*egg*;*.pyc;*.tox*"  \
    --command='clear; echo "${watch_event_type} ${watch_src_path}"; echo "launching tox..."; tox -q' \
    .
}
